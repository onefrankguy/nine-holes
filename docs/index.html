<!DOCTYPE html>

<html>
<head>
  <title>game.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>game.js</h1>
        

        
      </div>

      
        
        <p>How do you make a video game?</p>
<p>When I created <a href="http://prolix-app.com/" title="Prolix is a word search game for the iPhone and iPod touch which lets you tweet your scores so your friends can play with you.">Prolix</a>, I didn’t know what I was doing. I had a basic
understanding of web design, but I didn’t know JavaScript. What I wanted was
a video game built on open web standards. Something where I could read the
code and understand it and change the rules and make it my own.</p>
<p>This is that game.</p>
<hr>

        
      
        
        <p><strong>Nine Holes</strong> is an old two-player game. It’s played on a 3 x 3 board and
is reminiscent of tic-tac-toe. Players have three pieces each. They take
turns putting them on the board, and the winner is first to get three in
a row. Unlike tic-tac-toe, diagonals don’t count for a win, and pieces can be
moved after they’re played.</p>
<p>So how do we make that into a video game? Well, let’s start with a board.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">const</span> Board = {};</pre></div>
        
      
        
        <style>
td {
  font: 1rem/1 sans-serif;
  width: 1.8rem;
  height: 1.8rem;
  border: 1px solid gray;
  text-align: center;
}
td.label {
  border: none;
}
</style>

        
      
        
        <p>When talking about board games, it’s useful to be able to describe both the
players and the moves they make in shorthand. Chess notation used numbers for
ranks (rows) and letters for files (columns). So we can draw a 3 x 3 board
like this:</p>
<table>
<tr><td class="label">3</td><td></td><td></td><td></td></tr>
<tr><td class="label">2</td><td></td><td></td><td></td></tr>
<tr><td class="label">1</td><td></td><td></td><td></td></tr>
<tr><td class="label"></td><td class="label">a</td><td class="label">b</td><td class="label">c</td></tr>
</table>

<p>We can reference any space on our board as a letter and number. So “a1” is
the space in the lower left corner, and “c3” is the space in the upper right
corner.</p>
<p>Since we used “a” and “b” as column labels, so we’ll use X and Y for the
players. In our game, players don’t start with pieces on the board. But in
other games, like Checkers, they do. Let’s extend our board slightly so it
has starting spaces for the pieces.</p>
<table>
<tr><td class="label">5</td><td>y</td><td>y</td><td>y</td></tr>
<tr><td class="label">4</td><td></td><td></td><td></td></tr>
<tr><td class="label">3</td><td></td><td></td><td></td></tr>
<tr><td class="label">2</td><td></td><td></td><td></td></tr>
<tr><td class="label">1</td><td>x</td><td>x</td><td>x</td></tr>
<tr><td class="label"></td><td class="label">a</td><td class="label">b</td><td class="label">c</td></tr>
</table>

<p>Every time we start a new game, that’s what we want the board to look like.
So let’s give ourselves a way to create new game boards.</p>

        
          <div class='highlight'><pre>
Board.create = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> files = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>];
  <span class="hljs-keyword">const</span> ranks = [<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>, <span class="hljs-string">'4'</span>, <span class="hljs-string">'5'</span>];

  <span class="hljs-keyword">const</span> layout = {};

  files.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
    ranks.forEach(<span class="hljs-function">(<span class="hljs-params">rank</span>) =&gt;</span> {
      layout[file + rank] = <span class="hljs-string">''</span>;
    });
  });

  files.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
    layout[<span class="hljs-string">`<span class="hljs-subst">${file}</span>1`</span>] = <span class="hljs-string">'x'</span>;
    layout[<span class="hljs-string">`<span class="hljs-subst">${file}</span>5`</span>] = <span class="hljs-string">'y'</span>;
  });

  <span class="hljs-keyword">return</span> {
    files,
    ranks,
    layout,
  };
};</pre></div>
        
      
        
        <p>The <code>Board.create</code> function returns everything we need to draw a picture of
the game. The board shouldn’t know or care how it’s rendered. For all it
knows, we could be playing this game on a terminal and drawing it out in
ASCII text.</p>
<p>Now that we can draw the board, we need a way to move pieces around it. If X
starts by moving from a1 to c4, we can write that as “a1-c4”. If Y responds
by moving b5 to a4, we can write that as “b5-a4”. We can keep both those
moves in a list, <code>[&quot;a1-c4&quot;, &quot;b5-a4&quot;]</code>, and give ourselves a way to make them.</p>

        
          <div class='highlight'><pre>
Board.move = <span class="hljs-function">(<span class="hljs-params">board, moves</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> copy = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(board));

  moves.forEach(<span class="hljs-function">(<span class="hljs-params">move</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> [start, end] = move.split(<span class="hljs-string">'-'</span>);
    copy.layout[end] = copy.layout[start];
    copy.layout[start] = <span class="hljs-string">''</span>;
  });

  <span class="hljs-keyword">return</span> copy;
};</pre></div>
        
      
        
        <p>The <code>Board.move</code> function uses <code>JSON.stringify</code> and <code>JSON.parse</code> to make a
deep copy of a boad before updating it. This keeps the function pure. The
same board and the same moves always give the same output. Pure functions
are easier to debug than functions that mutate state, so we’ll try to write
as many of them as we can.</p>
<p>We now have enough code to run a tiny test. We’ll create a new board, make
two moves on it, and see how the board changes.</p>
<pre><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testImmutableBoard</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> starting = Board.create();
  <span class="hljs-keyword">const</span> playing = Board.move(starting, [<span class="hljs-string">'a1-c4'</span>, <span class="hljs-string">'b5-a4'</span>]);

  assert(starting[<span class="hljs-string">'a1'</span>] === <span class="hljs-string">'x'</span>);
  assert(starting[<span class="hljs-string">'c4'</span>] === <span class="hljs-string">''</span>);
  assert(starting[<span class="hljs-string">'b5'</span>] === <span class="hljs-string">'y'</span>);
  assert(starting[<span class="hljs-string">'a4'</span>] === <span class="hljs-string">''</span>);

  assert(playing[<span class="hljs-string">'a1'</span>] === <span class="hljs-string">''</span>);
  assert(playing[<span class="hljs-string">'c4'</span>] === <span class="hljs-string">'x'</span>);
  assert(playing[<span class="hljs-string">'b5'</span>] === <span class="hljs-string">''</span>);
  assert(playing[<span class="hljs-string">'a4'</span>] === <span class="hljs-string">'y'</span>);
}());
</code></pre><p>Here’s the board after those two moves:</p>
<table>
<tr><td class="label">5</td><td>y</td><td></td><td>y</td></tr>
<tr><td class="label">4</td><td>y</td><td></td><td>x</td></tr>
<tr><td class="label">3</td><td></td><td></td><td></td></tr>
<tr><td class="label">2</td><td></td><td></td><td></td></tr>
<tr><td class="label">1</td><td></td><td>x</td><td>x</td></tr>
<tr><td class="label"></td><td class="label">a</td><td class="label">b</td><td class="label">c</td></tr>
</table>

<p>What’s the next move? X could play “b1-b4” and try to stack pieces on top of
each other. That would be illegal, but the <code>Board.move</code> function doesn’t know
the rules of the game. Just like how we don’t want the board to know or care
how it’s displayed, we also don’t want it to know or care about rules. We’ll
figure those out next.</p>

        
          <div class='highlight'><pre>
<span class="hljs-keyword">const</span> Rules = {};</pre></div>
        
      
        
        <p>You can move your own pieces.</p>

        
          <div class='highlight'><pre>
Rules.pickable = <span class="hljs-function">(<span class="hljs-params">board, player</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> spaces = <span class="hljs-built_in">Object</span>.keys(board.layout);
  <span class="hljs-keyword">return</span> spaces.filter(<span class="hljs-function"><span class="hljs-params">space</span> =&gt;</span> board.layout[space] === player);
};</pre></div>
        
      
        
        <p>You can move a piece to an empty non-starting space.</p>

        
          <div class='highlight'><pre>
Rules.starting = <span class="hljs-function">(<span class="hljs-params">board</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> spaces = <span class="hljs-built_in">Object</span>.keys(board.layout);
  <span class="hljs-keyword">return</span> spaces.filter(<span class="hljs-function"><span class="hljs-params">space</span> =&gt;</span> space.charAt(<span class="hljs-number">1</span>) === <span class="hljs-string">'1'</span> || space.charAt(<span class="hljs-number">1</span>) === <span class="hljs-string">'5'</span>);
};

Rules.playable = <span class="hljs-function">(<span class="hljs-params">board</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> spaces = <span class="hljs-built_in">Object</span>.keys(board.layout);
  <span class="hljs-keyword">const</span> empty = spaces.filter(<span class="hljs-function"><span class="hljs-params">space</span> =&gt;</span> board.layout[space] === <span class="hljs-string">''</span>);

  <span class="hljs-keyword">const</span> starting = Rules.starting(board);
  <span class="hljs-keyword">return</span> empty.filter(<span class="hljs-function"><span class="hljs-params">space</span> =&gt;</span> starting.indexOf(space) &lt; <span class="hljs-number">0</span>);
};</pre></div>
        
      
        
        <p>So every combination of a piece you can pick up and a space you can play
into, is an allowed move.</p>

        
          <div class='highlight'><pre>
Rules.moves = <span class="hljs-function">(<span class="hljs-params">board, player</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> pickable = Rules.pickable(board, player);
  <span class="hljs-keyword">const</span> playable = Rules.playable(board);
  <span class="hljs-keyword">const</span> moves = [];

  pickable.forEach(<span class="hljs-function">(<span class="hljs-params">start</span>) =&gt;</span> {
    playable.forEach(<span class="hljs-function">(<span class="hljs-params">end</span>) =&gt;</span> {
      moves.push(<span class="hljs-string">`<span class="hljs-subst">${start}</span>-<span class="hljs-subst">${end}</span>`</span>);
    });
  });

  <span class="hljs-keyword">return</span> moves;
};</pre></div>
        
      
        
        <p>That’s enough to write a tiny test. Continuing the game above, X has three
pieces, and there are seven empty spaces to play into. So that’s twenty-one
allowed moves.</p>
<pre><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testMovementRules</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> starting = Board.create();
  <span class="hljs-keyword">const</span> playing = Board.move(starting, [<span class="hljs-string">'a1-c4'</span>, <span class="hljs-string">'b5-a4'</span>]);
  <span class="hljs-keyword">const</span> moves = Rules.moves(playing, <span class="hljs-string">'x'</span>);

  assert(moves.length === <span class="hljs-number">21</span>);
}());
</code></pre><p>The game is over when either player wins by getting three of their pieces in
a row. Diagonals don’t count though, and we don’t want to include pieces in
starting spaces.</p>

        
          <div class='highlight'><pre>
Rules.winner = <span class="hljs-function">(<span class="hljs-params">board</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> files = board.files.slice();
  <span class="hljs-keyword">const</span> ranks = board.ranks.slice(<span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);

  <span class="hljs-keyword">let</span> winner;

  ranks.forEach(<span class="hljs-function">(<span class="hljs-params">rank</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!winner) {
      <span class="hljs-keyword">const</span> players = [];

      files.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
        players.push(board.layout[file + rank]);
      });

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>(players).size === <span class="hljs-number">1</span> &amp;&amp; players[<span class="hljs-number">0</span>] !== <span class="hljs-string">''</span>) {
        [winner] = players;
      }
    }
  });

  files.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!winner) {
      <span class="hljs-keyword">const</span> players = [];

      ranks.forEach(<span class="hljs-function">(<span class="hljs-params">rank</span>) =&gt;</span> {
        players.push(board.layout[file + rank]);
      });

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>(players).size === <span class="hljs-number">1</span> &amp;&amp; players[<span class="hljs-number">0</span>] !== <span class="hljs-string">''</span>) {
        [winner] = players;
      }
    }
  });

  <span class="hljs-keyword">return</span> winner;
};</pre></div>
        
      
        
        <p>The decision to test for file wins first (vertical) instead of rank wins
(horizontal) is totally arbitrary. The <code>slice()</code> function is used to get
copies of the ranks and files from the board without changing it.</p>
<p>We’ll write a test to cover all four cases:</p>
<ol>
<li>Starting space don’t count.</li>
<li>Three in a row horizontally wins.</li>
<li>Three in a row vertically wins.</li>
<li>Three in a row diagonally doesn’t count.</li>
</ol>
<pre><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testWinnerRules</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> starting = Board.create();
  assert(Rules.winner(starting) === <span class="hljs-literal">undefined</span>);

  <span class="hljs-keyword">const</span> horizontal = Board.move(starting, [<span class="hljs-string">'a1-a2'</span>, <span class="hljs-string">'b1-b2'</span>, <span class="hljs-string">'c1-c2'</span>]);
  assert(Rules.winner(horizontal) === <span class="hljs-string">'x'</span>);

  <span class="hljs-keyword">const</span> vertical = Board.move(starting, [<span class="hljs-string">'a5-a4'</span>, <span class="hljs-string">'b5-a3'</span>, <span class="hljs-string">'c5-a2'</span>]);
  assert(Rules.winner(vertical) === <span class="hljs-string">'y'</span>);

  <span class="hljs-keyword">const</span> diagonal = Board.move(starting, [<span class="hljs-string">'a1-a2'</span>, <span class="hljs-string">'b1-b3'</span>, <span class="hljs-string">'c1-c4'</span>]);
  assert(Rules.winner(diagonal) === <span class="hljs-literal">undefined</span>);
}());
</code></pre><p>There are other edge cases we could cover, like three in a row vertically
where one of the pieces is in a starting space. But the goal here isn’t
exhaustive test coverage. Often the best way to test a game is to start
playing it. To do that, we’ll need an oppontent.</p>
<hr>

        
      
        
        <p>Let’s write an AI.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">const</span> AI = {};</pre></div>
        
      
        
        <p>Our AI can use the rules to find all the winning moves available to it.</p>

        
          <div class='highlight'><pre>
AI.winning = <span class="hljs-function">(<span class="hljs-params">board, player</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> moves = Rules.moves(board, player);
  <span class="hljs-keyword">return</span> moves.filter(<span class="hljs-function">(<span class="hljs-params">move</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> test = Board.move(board, [move]);
    <span class="hljs-keyword">return</span> Rules.winner(test) === player;
  });
};</pre></div>
        
      
        
        <p>Our AI can also use the rules to find all the blocking moves available to it.
Assume it’s the other player’s turn. What move would they make to win? If the
AI can find a move it can make that puts its piece in the same space, that’s
a blocking move.</p>

        
          <div class='highlight'><pre>
AI.blocking = <span class="hljs-function">(<span class="hljs-params">board, player</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> opponent = player === <span class="hljs-string">'x'</span> ? <span class="hljs-string">'y'</span> : <span class="hljs-string">'x'</span>;
  <span class="hljs-keyword">const</span> winning = AI.winning(board, opponent).map(<span class="hljs-function"><span class="hljs-params">move</span> =&gt;</span> move.slice(<span class="hljs-number">3</span>));
  <span class="hljs-keyword">const</span> blocking = Rules.moves(board, player);
  <span class="hljs-keyword">return</span> blocking.filter(<span class="hljs-function"><span class="hljs-params">move</span> =&gt;</span> winning.indexOf(move.slice(<span class="hljs-number">3</span>)) &gt; <span class="hljs-number">-1</span>);
};</pre></div>
        
      
        
        <p>Our AI wants to get all its pieces on the board. So it can use the rules to
find moves that originate from a starting space.</p>

        
          <div class='highlight'><pre>
AI.starting = <span class="hljs-function">(<span class="hljs-params">board, player</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> moves = Rules.moves(board, player);
  <span class="hljs-keyword">const</span> starting = Rules.starting(board);
  <span class="hljs-keyword">return</span> moves.filter(<span class="hljs-function"><span class="hljs-params">move</span> =&gt;</span> starting.indexOf(move.split(<span class="hljs-string">'-'</span>)[<span class="hljs-number">0</span>]) &gt; <span class="hljs-number">0</span>);
};</pre></div>
        
      
        
        <p>Our AI is simple. It plays a winning move if it sees one. Otherwise it plays
a blocking move. If it doesn’t see any winning or blocking moves, it plays a
legal move. It prefers to play starting moves first.</p>

        
          <div class='highlight'><pre>
AI.moves = <span class="hljs-function">(<span class="hljs-params">board, player</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> winning = AI.winning(board, player);
  <span class="hljs-keyword">if</span> (winning.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> winning;
  }

  <span class="hljs-keyword">const</span> blocking = AI.blocking(board, player);
  <span class="hljs-keyword">if</span> (blocking.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> blocking;
  }

  <span class="hljs-keyword">const</span> starting = AI.starting(board, player);
  <span class="hljs-keyword">if</span> (starting.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> starting;
  }

  <span class="hljs-keyword">return</span> Rules.moves(board, player);
};</pre></div>
        
      
        
        <p>Because our AI is stateless, and all its functions take a <code>player</code> argument,
it can play our game against itself.</p>
<pre><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testAI</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">let</span> board = Board.create();
  <span class="hljs-keyword">let</span> winner;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">play</span>(<span class="hljs-params">board, player</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${player}</span> is playing on <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(board.layout)}</span>`</span>);
    <span class="hljs-keyword">const</span> moves = AI.moves(board, player);
    <span class="hljs-keyword">const</span> index = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * moves.length);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${player}</span> plays`</span>, moves[index]);
    <span class="hljs-keyword">return</span> Board.move(board, [moves[index]]);
  }

  <span class="hljs-keyword">while</span> (!winner) {
    board = play(board, <span class="hljs-string">'x'</span>);
    board = play(board, <span class="hljs-string">'y'</span>);
    winner = Rules.winner(board);
  }

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${winner}</span> wins!`</span>);
}());
</code></pre>
        
          <div class='highlight'><pre>
<span class="hljs-keyword">const</span> Stage = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stage</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">let</span> board = Board.create();
  <span class="hljs-keyword">let</span> picked;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify({ board, picked }));
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reset</span>(<span class="hljs-params"></span>) </span>{
    board = Board.create();
    picked = <span class="hljs-literal">undefined</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-keyword">if</span> (Rules.winner(board)) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> pickable = Rules.pickable(board, <span class="hljs-string">'x'</span>).indexOf(message) &gt; <span class="hljs-number">-1</span>;

    <span class="hljs-keyword">if</span> (!picked) {
      <span class="hljs-keyword">if</span> (pickable) {
        picked = message;
      }
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> playable = Rules.playable(board).indexOf(message) &gt; <span class="hljs-number">-1</span>;

    <span class="hljs-keyword">if</span> (!playable) {
      <span class="hljs-keyword">if</span> (pickable) {
        picked = message;
      }
      <span class="hljs-keyword">return</span>;
    }

    board = Board.move(board, [<span class="hljs-string">`<span class="hljs-subst">${picked}</span>-<span class="hljs-subst">${message}</span>`</span>]);
    picked = <span class="hljs-literal">undefined</span>;

    <span class="hljs-keyword">if</span> (Rules.winner(board) === <span class="hljs-string">'x'</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> moves = AI.moves(board, <span class="hljs-string">'y'</span>);
    <span class="hljs-keyword">if</span> (moves.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">const</span> index = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * moves.length);
      board = Board.move(board, [moves[index]]);
    }
  }

  <span class="hljs-keyword">return</span> {
    get,
    next,
    reset,
  };
}());

<span class="hljs-keyword">const</span> Renderer = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderer</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">let</span> dirty = <span class="hljs-literal">true</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderBoard</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> $ = <span class="hljs-built_in">window</span>.jQuery;
    <span class="hljs-keyword">const</span> { layout } = Stage.get().board;

    <span class="hljs-built_in">Object</span>.keys(layout).forEach(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> element = $(<span class="hljs-string">`#<span class="hljs-subst">${id}</span>`</span>);
      <span class="hljs-keyword">if</span> (layout[id] === <span class="hljs-string">''</span>) {
        element.remove(<span class="hljs-string">'white'</span>).remove(<span class="hljs-string">'black'</span>);
      }
      <span class="hljs-keyword">if</span> (layout[id] === <span class="hljs-string">'x'</span>) {
        element.add(<span class="hljs-string">'white'</span>).remove(<span class="hljs-string">'black'</span>);
      }
      <span class="hljs-keyword">if</span> (layout[id] === <span class="hljs-string">'y'</span>) {
        element.add(<span class="hljs-string">'black'</span>).remove(<span class="hljs-string">'white'</span>);
      }
    });
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderPicked</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> $ = <span class="hljs-built_in">window</span>.jQuery;
    <span class="hljs-keyword">const</span> { picked, board } = Stage.get();

    <span class="hljs-built_in">Object</span>.keys(board.layout).forEach(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
      $(<span class="hljs-string">`#<span class="hljs-subst">${id}</span>`</span>).remove(<span class="hljs-string">'picked'</span>);
    });

    <span class="hljs-keyword">if</span> (picked) {
      $(<span class="hljs-string">`#<span class="hljs-subst">${picked}</span>`</span>).add(<span class="hljs-string">'picked'</span>);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (dirty) {
      renderBoard();
      renderPicked();
      dirty = <span class="hljs-literal">false</span>;
    }

    requestAnimationFrame(render);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">invalidate</span>(<span class="hljs-params"></span>) </span>{
    dirty = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">return</span> {
    render,
    invalidate,
  };
}());

<span class="hljs-keyword">const</span> Game = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">game</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onPick</span>(<span class="hljs-params">element</span>) </span>{
    element.add(<span class="hljs-string">'picked'</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onPlay</span>(<span class="hljs-params">element</span>) </span>{
    Stage.next(element.unwrap().id);
    Renderer.invalidate();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onReset</span>(<span class="hljs-params">element</span>) </span>{
    element.add(<span class="hljs-string">'picked'</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">offReset</span>(<span class="hljs-params">element</span>) </span>{
    element.remove(<span class="hljs-string">'picked'</span>);
    Stage.reset();
    Renderer.invalidate();
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">play</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> $ = <span class="hljs-built_in">window</span>.jQuery;
    $(<span class="hljs-string">'#a4'</span>).touch(onPick, onPlay);
    $(<span class="hljs-string">'#b4'</span>).touch(onPick, onPlay);
    $(<span class="hljs-string">'#c4'</span>).touch(onPick, onPlay);

    $(<span class="hljs-string">'#a3'</span>).touch(onPick, onPlay);
    $(<span class="hljs-string">'#b3'</span>).touch(onPick, onPlay);
    $(<span class="hljs-string">'#c3'</span>).touch(onPick, onPlay);

    $(<span class="hljs-string">'#a2'</span>).touch(onPick, onPlay);
    $(<span class="hljs-string">'#b2'</span>).touch(onPick, onPlay);
    $(<span class="hljs-string">'#c2'</span>).touch(onPick, onPlay);

    $(<span class="hljs-string">'#a1'</span>).touch(onPick, onPlay);
    $(<span class="hljs-string">'#b1'</span>).touch(onPick, onPlay);
    $(<span class="hljs-string">'#c1'</span>).touch(onPick, onPlay);

    $(<span class="hljs-string">'#reset'</span>).touch(onReset, offReset);

    Stage.reset();
    Renderer.invalidate();
    Renderer.render();
  }

  <span class="hljs-keyword">return</span> {
    play,
  };
}());

(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">$</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Fn</span>(<span class="hljs-params">selector</span>) </span>{
    <span class="hljs-keyword">if</span> (selector <span class="hljs-keyword">instanceof</span> Fn) {
      <span class="hljs-keyword">return</span> selector;
    }

    <span class="hljs-keyword">this</span>.element = selector;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> selector === <span class="hljs-string">'string'</span>) {
      <span class="hljs-keyword">if</span> (selector.indexOf(<span class="hljs-string">'#'</span>) === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>.element = <span class="hljs-built_in">document</span>.getElementById(selector.slice(<span class="hljs-number">1</span>));
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  Fn.prototype.add = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">klass</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.element &amp;&amp; <span class="hljs-keyword">this</span>.element.classList) {
      <span class="hljs-keyword">this</span>.element.classList.add(klass);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };

  Fn.prototype.remove = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">remove</span>(<span class="hljs-params">klass</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.element &amp;&amp; <span class="hljs-keyword">this</span>.element.classList) {
      <span class="hljs-keyword">this</span>.element.classList.remove(klass);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };

  Fn.prototype.touch = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">touch</span>(<span class="hljs-params">start, end</span>) </span>{
    <span class="hljs-keyword">const</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.element) {
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'ontouchstart'</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">document</span>.documentElement === <span class="hljs-literal">false</span>) {
        <span class="hljs-keyword">this</span>.element.onmousedown = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onmousedown</span>(<span class="hljs-params">mouseDownEvent</span>) </span>{
          <span class="hljs-keyword">if</span> (start) {
            start(self, mouseDownEvent);
          }
          <span class="hljs-built_in">document</span>.onmousemove = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onmousemove</span>(<span class="hljs-params">e</span>) </span>{
            e.preventDefault();
          };
          <span class="hljs-built_in">document</span>.onmouseup = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onmouseup</span>(<span class="hljs-params">e</span>) </span>{
            <span class="hljs-keyword">if</span> (end) {
              end(self, e);
            }
            <span class="hljs-built_in">document</span>.onmousemove = <span class="hljs-literal">undefined</span>;
            <span class="hljs-built_in">document</span>.onmouseup = <span class="hljs-literal">undefined</span>;
          };
        };
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.element.ontouchstart = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ontouchstart</span>(<span class="hljs-params">touchStartEvent</span>) </span>{
          <span class="hljs-keyword">if</span> (start) {
            start(self, touchStartEvent);
          }
          <span class="hljs-built_in">document</span>.ontouchmove = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ontouchmove</span>(<span class="hljs-params">e</span>) </span>{
            e.preventDefault();
          };
          <span class="hljs-built_in">document</span>.ontouchend = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ontouchend</span>(<span class="hljs-params">e</span>) </span>{
            <span class="hljs-keyword">if</span> (end) {
              end(self, e);
            }
            <span class="hljs-built_in">document</span>.ontouchmove = <span class="hljs-literal">undefined</span>;
            <span class="hljs-built_in">document</span>.ontouchend = <span class="hljs-literal">undefined</span>;
          };
        };
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };

  Fn.prototype.unwrap = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unwrap</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.element;
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">root</span>(<span class="hljs-params">selector</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Fn(selector);
  }

  <span class="hljs-built_in">window</span>.jQuery = root;
}());

Game.play();</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
